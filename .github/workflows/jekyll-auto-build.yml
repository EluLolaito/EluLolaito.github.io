name: Build Jekyll Site

on:
  push:
    branches:
      - master
  repository_dispatch:
    types: [google-sheets-update]

env:
  PAGES_REPO_NWO: EluLolaito/EluLolaito.github.io

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch CSV from Google Sheets
        run: |
          mkdir -p _data
          curl -L "${{ secrets.CSV_URL }}" -o _data/skysheets.csv

      - name: Fetch YML from Google Sheets
        run: |
          mkdir -p _data
          curl -L "${{ secrets.YML_URL }}" -o _data/songs.yml

      - name: Check if _data folder exists and list its contents
        run: |
          echo "Checking if _data folder exists..."
          if [ -d "_data" ]; then
            echo "_data folder exists"
            ls -l _data
          else
            echo "_data folder does not exist"
          fi

      - name: Check CSV file
        run: ls -l _data && cat _data/skysheets.csv || echo "CSV file missing!"

      - name: Check YML file
        run: ls -l _data && cat _data/songs.yml || echo "YML file missing!"

      # - name: Convert CSV to YAML
      #   run: |
      #     cat _data/skysheets.csv | tee _data/skysheets_yml.yml

      - name: Setup Ruby & Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Build Jekyll site
        run: JEKYLL_ENV=production bundle exec jekyll build --verbose

      - name: Debug Jekyll Data
        run: |
          echo "Checking _data folder after build..."
          ls -l _data
          cat _data/skysheets.csv

      # - name: Debug YAML file
      #   run: |
      #     echo "===== Checking _data/skysheets.yml ====="
      #     cat _data/skysheets_yml.yml || echo "YAML file missing!"

        # - name: Remove CSV after build
        #   run: rm _data/skysheets.csv

        # - name: Deploy to GitHub Pages
        #   uses: JamesIves/github-pages-deploy-action@v4
        #   with:
        #     branch: gh-pages
        #     folder: _site
